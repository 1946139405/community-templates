<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export>
    <version>5.4</version>
    <date>2022-01-17T03:32:25Z</date>
    <groups>
        <group>
            <uuid>02e4df4f20b848e79267641790f241da</uuid>
            <name>Templates/Virtualization</name>
        </group>
        <group>
            <uuid>da8c196aab9e4705ac1abf71aaf93885</uuid>
            <name>VMmanager 6</name>
        </group>
    </groups>
    <templates>
        <template>
            <uuid>a3d49230da2744a29bbf466bd27ebd6e</uuid>
            <template>Template VMmanager 6 KVM Hypervisor</template>
            <name>Template VMmanager 6 KVM Hypervisor</name>
            <description>Version 2021-12-16

Template for monitoring  VMmanager 6 KVM host 

1. Template uses zabbix-agent2

2. Create /etc/sudoers.d/zabbix with
Defaults:zabbix !requiretty
Cmnd_Alias ZABBIX_CMD = /usr/bin/virsh -q list, /usr/bin/virsh -q list --all
zabbix ALL = (root) NOPASSWD: ZABBIX_CMD

3. Create /etc/zabbix/zabbix_agent2.d/vmmanager.conf with
UserParameter=vm.all,sudo virsh -q list --all | wc -l
UserParameter=vm.running,sudo virsh -q list | wc -l</description>
            <groups>
                <group>
                    <name>Templates/Virtualization</name>
                </group>
                <group>
                    <name>VMmanager 6</name>
                </group>
            </groups>
            <items>
                <item>
                    <uuid>0c15d076b1c34b7e9823f4c8127b1edd</uuid>
                    <name>VM All Count</name>
                    <key>vm.all</key>
                    <delay>10m</delay>
                    <tags>
                        <tag>
                            <tag>Application</tag>
                            <value>VM</value>
                        </tag>
                    </tags>
                </item>
                <item>
                    <uuid>22577b36a4d94974a6b0cd173d86b418</uuid>
                    <name>VM Running Count</name>
                    <key>vm.running</key>
                    <delay>10m</delay>
                    <tags>
                        <tag>
                            <tag>Application</tag>
                            <value>VM</value>
                        </tag>
                    </tags>
                </item>
            </items>
            <discovery_rules>
                <discovery_rule>
                    <uuid>b7cc9d3193cc47b99bf61f1a392f9ae3</uuid>
                    <name>VMmanager Services</name>
                    <key>systemd.unit.discovery</key>
                    <filter>
                        <evaltype>OR</evaltype>
                        <conditions>
                            <condition>
                                <macro>{#UNIT.NAME}</macro>
                                <value>^libvirtd</value>
                                <formulaid>A</formulaid>
                            </condition>
                            <condition>
                                <macro>{#UNIT.NAME}</macro>
                                <value>^ha-agent</value>
                                <formulaid>B</formulaid>
                            </condition>
                            <condition>
                                <macro>{#UNIT.NAME}</macro>
                                <value>^frr</value>
                                <formulaid>C</formulaid>
                            </condition>
                            <condition>
                                <macro>{#UNIT.NAME}</macro>
                                <value>^bird</value>
                                <formulaid>D</formulaid>
                            </condition>
                        </conditions>
                    </filter>
                    <item_prototypes>
                        <item_prototype>
                            <uuid>4d2a0c1aada34035b0faa06be6dc1ec0</uuid>
                            <name>{#UNIT.DESCRIPTION}</name>
                            <key>systemd.unit.info[&quot;{#UNIT.NAME}&quot;,ActiveState]</key>
                            <trends>0</trends>
                            <value_type>TEXT</value_type>
                            <tags>
                                <tag>
                                    <tag>Application</tag>
                                    <value>Process</value>
                                </tag>
                            </tags>
                            <trigger_prototypes>
                                <trigger_prototype>
                                    <uuid>522f2103d8d74c20b3f4f02c46ad17af</uuid>
                                    <expression>last(/Template VMmanager 6 KVM Hypervisor/systemd.unit.info[&quot;{#UNIT.NAME}&quot;,ActiveState],#3:now-1m)&lt;&gt;&quot;active&quot;</expression>
                                    <name>{#UNIT.NAME} DOWN</name>
                                    <priority>AVERAGE</priority>
                                </trigger_prototype>
                            </trigger_prototypes>
                        </item_prototype>
                    </item_prototypes>
                </discovery_rule>
            </discovery_rules>
        </template>
    </templates>
    <graphs>
        <graph>
            <uuid>c6b65d447fee478d935ab40ea67de35c</uuid>
            <name>VM Count</name>
            <show_triggers>NO</show_triggers>
            <graph_items>
                <graph_item>
                    <sortorder>1</sortorder>
                    <color>1A7C11</color>
                    <item>
                        <host>Template VMmanager 6 KVM Hypervisor</host>
                        <key>vm.all</key>
                    </item>
                </graph_item>
                <graph_item>
                    <sortorder>2</sortorder>
                    <color>F63100</color>
                    <item>
                        <host>Template VMmanager 6 KVM Hypervisor</host>
                        <key>vm.running</key>
                    </item>
                </graph_item>
            </graph_items>
        </graph>
    </graphs>
</zabbix_export>
